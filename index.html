<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0a0f16" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Gestione Materiali ‚Äî Glass (v1.4.7)</title>
<style>
  /* ===== Tema scuro vetro (leggermente pi√π chiaro) ===== */
  :root{
    --text:#f7faff;
    --muted:#d1d9ec;
    --accent:#7fb0ff;

    --bg1:#08101c; --bg2:#0a1730;
    --blobA:#2b65ff; --blobB:#0aa9b6; --blobC:#103b84; --blobD:#0f6a7a;

    /* pannelli un filo pi√π chiari */
    --panel: rgba(18,24,36,.76);
    --panel-weak: rgba(18,24,36,.58);
    --panel-border: rgba(255,255,255,.12);
    --panel-border-strong: rgba(255,255,255,.18);

    /* Navigazione a contrasto alto ma pi√π luminosa */
    --nav-bg: rgba(10,16,24,.94);
    --nav-item: rgba(255,255,255,.08);
    --nav-item-hover: rgba(255,255,255,.16);
    --nav-item-activeA: rgba(127,176,255,.32);
    --nav-item-activeB: rgba(10,169,182,.26);
    --nav-border: rgba(255,255,255,.28);
    --nav-border-strong: rgba(255,255,255,.38);

    --radius:20px; --shadow:0 12px 40px rgba(0,0,0,.42);
  }

  *{box-sizing:border-box}
  html{height:100%; -webkit-text-size-adjust:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",Helvetica,Arial;
    color:var(--text); min-height:100svh; overflow-x:hidden; -webkit-tap-highlight-color:transparent;
    background: radial-gradient(1200px 900px at 20% 0%, var(--bg2) 0%, var(--bg1) 60%) fixed;
    position:relative; padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom);
  }
  body::before, body::after{
    content:""; position:fixed; inset:-25% -20% auto -20%; height:140svh; pointer-events:none; z-index:-2;
    background:
      radial-gradient(40% 35% at 12% 18%, color-mix(in oklab, var(--blobB) 60%, #000 40%) 0%, transparent 70%),
      radial-gradient(38% 33% at 90% 12%, color-mix(in oklab, var(--blobA) 62%, #000 38%) 0%, transparent 72%),
      radial-gradient(50% 50% at 55% 90%, color-mix(in oklab, var(--blobD) 60%, #000 40%) 0%, transparent 68%),
      radial-gradient(60% 50% at 0% 100%, color-mix(in oklab, var(--blobC) 58%, #000 42%) 0%, transparent 70%);
    filter: blur(48px) saturate(120%); opacity:.8;
  }
  body::after{ inset:auto -25% -15% -25%; transform:translateY(-10%); filter:blur(60px) saturate(140%); opacity:.5 }

  .grow{flex:1} .mt-6{margin-top:6px} .mt-10{margin-top:10px} .mt-16{margin-top:16px}

  .app{display:grid;grid-template-rows:64px 1fr;min-height:100svh}
  header.appbar{
    position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:12px;
    padding: calc(8px + env(safe-area-inset-top)) 14px 10px;
    background: linear-gradient(180deg, rgba(8,15,22,.85), rgba(8,15,22,.55));
    -webkit-backdrop-filter: blur(10px) saturate(160%); backdrop-filter: blur(10px) saturate(160%);
    border-bottom:1px solid var(--panel-border-strong);
  }
  .appmain{padding:22px clamp(12px,4vw,44px) 44px}

  .screen{display:none}
  .screen.active{display:block}

  .glass{
    background: linear-gradient(160deg, var(--panel), var(--panel-weak));
    border:1px solid var(--panel-border);
    border-radius:var(--radius);
    -webkit-backdrop-filter: blur(14px) saturate(160%); backdrop-filter: blur(14px) saturate(160%);
    box-shadow: var(--shadow);
  }

  .hamburger{width:44px;height:44px;display:grid;place-items:center;border-radius:14px}
  .hamburger,.pill{ background: linear-gradient(160deg, rgba(255,255,255,.10), rgba(255,255,255,.05)); border:1px solid var(--panel-border); box-shadow: var(--shadow); }
  .hamburger .bars{display:grid;gap:4px}
  .hamburger .bars span{width:18px;height:2px;background:#eff3ff;border-radius:2px}
  .brand{font-weight:900;letter-spacing:.3px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;font-size:13px;border-radius:14px}

  /* Drawer (NAV) */
  .drawer{position:fixed;inset:0 auto 0 0;width:min(320px,86vw);transform:translateX(-100%);transition:.28s transform;z-index:1000}
  .drawer.open{transform:translateX(0)}
  .drawer-panel{
    height:100%;
    padding:calc(14px + env(safe-area-inset-top)) 14px 14px;
    display:flex;flex-direction:column;gap:10px;
    background: linear-gradient(180deg, var(--nav-bg), rgba(8,12,18,.92));
    border-right:1px solid var(--nav-border);
    -webkit-backdrop-filter: blur(10px) saturate(180%);
    backdrop-filter: blur(10px) saturate(180%);
  }
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);opacity:0;pointer-events:none;transition:opacity .25s;z-index:900}
  .overlay.show{opacity:1;pointer-events:auto}
  .title{font-size:12px;text-transform:uppercase;letter-spacing:.14em;color:#ffffff;margin:6px 8px 2px;opacity:.95}
  .navlink{
    display:flex;align-items:center;gap:10px;
    padding:14px 12px;border-radius:14px;color:#fff;
    background: var(--nav-item); border:1px solid var(--nav-border);
    font-weight:700;
  }
  .navlink:hover{background:var(--nav-item-hover);border-color:var(--nav-border-strong)}
  .navlink.active{
    background: linear-gradient(160deg, var(--nav-item-activeA), var(--nav-item-activeB));
    border-color: rgba(127,176,255,.55);
  }
  .nav-bottom{margin-top:auto;border-top:1px dashed var(--nav-border-strong);padding-top:10px}
  .icon{width:20px;display:grid;place-items:center}

  /* HOME pulita */
  .home-wrap{display:grid;gap:18px;max-width:1000px;margin:0 auto}
  .home-card{display:grid;gap:8px;place-items:center;text-align:center;padding:34px}
  .clock{font-size:clamp(60px,18vw,110px);font-weight:1000;line-height:1}
  .date{color:#f1f5ff}

  /* Form + bottoni */
  form .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .field{display:grid;gap:8px}
  .field label{color:#f3f6ff;font-size:12px;letter-spacing:.06em;text-transform:uppercase}
  .field input,.field textarea,.field select{
    width:100%;border-radius:14px;padding:12px 12px;color:#ffffff;border:1px solid var(--panel-border-strong);
    background: linear-gradient(160deg, rgba(18,24,36,.86), rgba(18,24,36,.64));
    -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
  }
  .field input::placeholder,.field textarea::placeholder{color:#e5ebff}
  .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;margin-top:8px}
  .btn{
    border:1px solid var(--panel-border-strong);border-radius:14px;font-weight:800;font-size:16px;padding:12px 16px;color:var(--text);
    background: linear-gradient(160deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); box-shadow: var(--shadow);
  }
  .btn.primary{background:linear-gradient(160deg, rgba(127,176,255,.38), rgba(10,169,182,.30))}

  /* Tabelle */
  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table thead th{
    position:sticky;top:0;text-align:left;padding:10px;
    background: rgba(8,12,18,.92); color:#fff; border-bottom:1px solid var(--panel-border-strong);
  }
  .table td{padding:10px;border-bottom:1px dashed var(--panel-border);vertical-align:top}
  .empty{padding:18px;text-align:center;color:#fff;border:1px dashed var(--panel-border-strong);border-radius:14px;background:rgba(8,12,18,.78)}

  /* Responsive table come card */
  .rtable{width:100%}
  @media (max-width:720px){
    .rtable thead{display:none}
    .rtable tbody,.rtable tr,.rtable td{display:block;width:100%}
    .rtable tr{
      margin-bottom:12px;border-radius:16px;
      background: rgba(8,12,18,.84); border:1px solid var(--panel-border-strong); padding:10px; box-shadow: var(--shadow);
    }
    .rtable td{border:none;border-bottom:1px dashed var(--panel-border);padding:8px 6px}
    .rtable td:last-child{border-bottom:none}
    .rtable td[data-label]::before{
      content:attr(data-label) " ";font-weight:800;color:#ffffff;margin-right:8px;display:inline-block;min-width:110px
    }
    .rtable td[data-actions]{text-align:right;padding-top:10px}
  }
  .subrow td{background:rgba(8,12,18,.82);border-bottom:1px dashed var(--panel-border)}

  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  @media (max-width:840px){.col-8,.col-6,.col-4,.col-3{grid-column:span 12}}
</style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <button id="btnMenu" class="hamburger glass" aria-label="Apri menu"><span class="bars"><span></span><span></span><span></span></span></button>
    <div class="brand">Gestione Materiali ¬∑ Glass</div>
    <div class="grow"></div>
    <div class="pill">üïò <span id="appClockSmall">--:--</span></div>
  </header>

  <main class="appmain">
    <!-- HOME: solo ora e data -->
    <section id="screen-home" class="screen active">
      <div class="home-wrap">
        <div class="card glass home-card">
          <div class="clock" id="bigClock">--:--:--</div>
          <div class="date" id="bigDate">‚Äî ‚Äî</div>
        </div>
      </div>
    </section>

    <!-- AGGIUNGI CODICE -->
    <section id="screen-add-code" class="screen">
      <div class="card glass">
        <div class="card-header">
          <h2 id="addCodeTitle">Aggiungi codice</h2>
          <span class="pill" id="editBadge" style="display:none">Modalit√† modifica</span>
        </div>
        <form id="codeForm">
          <div class="grid">
            <div class="field col-6"><label for="cTitolo">Titolo</label><input id="cTitolo" required /></div>
            <div class="field col-6"><label for="cCodice">Codice</label><input id="cCodice" required autocapitalize="characters" /></div>
            <div class="field col-12"><label for="cDesc">Descrizione</label><textarea id="cDesc" placeholder="Dettagli, note tecniche‚Ä¶"></textarea></div>
            <div class="field col-4"><label for="cQty">Quantit√†</label><input id="cQty" type="number" inputmode="numeric" min="0" step="1" value="0" /></div>
            <div class="field col-4"><label for="cUnit">Unit√† di misura</label><input id="cUnit" placeholder="pz, m, kg‚Ä¶" /></div>
            <div class="field col-4"><label for="cExtra">Note (opz.)</label><input id="cExtra" /></div>
          </div>
          <div class="actions">
            <button type="button" class="btn" id="resetCodeForm">Annulla</button>
            <button type="submit" class="btn primary" id="saveCodeBtn">Salva codice</button>
          </div>
          <div class="mt-10 date" id="codeSavedMsg" style="display:none">‚úÖ Codice salvato.</div>
        </form>
      </div>
    </section>

    <!-- AGGIUNGI LISTA -->
    <section id="screen-add-list" class="screen">
      <div class="card glass">
        <div class="card-header">
          <h2 id="addListTitle">Aggiungi lista</h2>
          <span class="pill" id="editListBadge" style="display:none">Modifica lista</span>
        </div>
        <form id="listForm">
          <div class="grid">
            <div class="field col-6"><label for="lNome">Nome lista</label><input id="lNome" required /></div>
            <div class="field col-6"><label for="lDesc">Descrizione (opz.)</label><input id="lDesc" /></div>
          </div>

          <div class="grid mt-16">
            <div class="field col-12">
              <label for="lSearch">Cerca materiale (codice)</label>
              <input id="lSearch" placeholder="Digita il codice‚Ä¶ e premi Invio" />
            </div>
          </div>

          <div class="mt-10" id="searchResults"></div>

          <div class="mt-16">
            <h3>Elenco della lista</h3>
            <div id="listItemsArea" class="mt-6 empty">Ancora nessun materiale aggiunto.</div>
          </div>

          <div class="actions mt-16">
            <button type="button" class="btn" id="clearListBuilder">Svuota</button>
            <button type="submit" class="btn primary">Salva lista</button>
          </div>
          <div class="mt-10 date" id="listSavedMsg" style="display:none">‚úÖ Lista salvata.</div>
        </form>
      </div>
    </section>

    <!-- TUTTI I CODICI -->
    <section id="screen-all-codes" class="screen">
      <div class="card glass">
        <div class="card-header"><h2 id="allCodesTitle">Tutti i codici</h2><div class="actions"><button class="btn" data-go="#screen-add-code">‚ûï Nuovo</button></div></div>
        <div class="grid">
          <div class="field col-8"><label for="codesSearch">Filtra</label><input id="codesSearch" placeholder="Digita per filtrare‚Ä¶" /></div>
          <div class="field col-4"><label>&nbsp;</label><div class="pill">üì¶ <span id="codesCount">0</span> elementi</div></div>
        </div>
        <div class="mt-10" id="codesTableWrap"><div class="empty">Non ci sono codici.</div></div>
      </div>
    </section>

    <!-- LISTE -->
    <section id="screen-lists" class="screen">
      <div class="card glass">
        <div class="card-header"><h2 id="listsTitle">Liste</h2><div class="actions"><button class="btn" data-go="#screen-add-list">‚ûï Nuova lista</button></div></div>
        <div class="grid">
          <div class="field col-8"><label for="listsSearch">Filtra</label><input id="listsSearch" placeholder="Cerca per nome o descrizione‚Ä¶" /></div>
          <div class="field col-4"><label>&nbsp;</label><div class="pill">üóÇÔ∏è <span id="listsCount">0</span> liste</div></div>
        </div>
        <div class="mt-10" id="listsTableWrap"><div class="empty">Non ci sono ancora liste salvate.</div></div>
      </div>
    </section>

    <!-- ESPORTAZIONE -->
    <section id="screen-export" class="screen">
      <div class="card glass">
        <div class="card-header"><h2 id="exportTitle">Esportazione</h2></div>
        <div class="grid"><div class="field col-12"><label for="listSelectExport">Seleziona una lista</label><select id="listSelectExport" class="glass" style="padding:10px"></select></div></div>
        <div class="actions mt-10">
          <button class="btn primary" id="btnExportPDF">üßæ Esporta lista in PDF</button>
          <button class="btn" id="btnExportJSON">‚¨áÔ∏è Esporta JSON</button>
          <label class="btn warn" for="fileImportJSON" style="display:inline-block">‚¨ÜÔ∏è Importa JSON</label>
          <input id="fileImportJSON" type="file" accept=".json,application/json" style="display:none" />
          <button class="btn danger" id="btnWipeAll">üóëÔ∏è Cancella TUTTO (local)</button>
        </div>
        <p class="date mt-10">I dati sono salvati <strong>solo</strong> nel tuo browser.</p>
      </div>
    </section>
  </main>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer" role="dialog" aria-label="Menu">
  <div class="drawer-panel">
    <div class="title">Navigazione</div>
    <button class="navlink" data-go="#screen-home"><span class="icon">üè†</span>Home</button>
    <button class="navlink" data-go="#screen-add-code"><span class="icon">‚ûï</span>Aggiungi codice</button>
    <button class="navlink" data-go="#screen-add-list"><span class="icon">üìù</span>Aggiungi lista</button>
    <button class="navlink" data-go="#screen-all-codes"><span class="icon">üìö</span>Tutti i codici</button>
    <button class="navlink" data-go="#screen-lists"><span class="icon">üóÇÔ∏è</span>Liste</button>
    <div class="nav-bottom"><button class="navlink" data-go="#screen-export"><span class="icon">‚§¥Ô∏è</span>Esportazione</button></div>
  </div>
</div>
<div class="overlay" id="overlay" aria-hidden="true"></div>

<div id="toast" class="pill" style="position:fixed;left:50%;bottom:calc(24px + env(safe-area-inset-bottom));transform:translateX(-50%) translateY(20px);opacity:0;transition:.25s;z-index:2000"></div>

<script>
  /* === Stato/Storage === */
  const TZ='Europe/Rome';
  const Store={ keyCodes:'gm_codes_v1', keyLists:'gm_lists_v1', keyName:'gm_username_v1',
    getCodes(){return JSON.parse(localStorage.getItem(this.keyCodes)||'[]')},
    setCodes(a){localStorage.setItem(this.keyCodes,JSON.stringify(a))},
    getLists(){return JSON.parse(localStorage.getItem(this.keyLists)||'[]')},
    setLists(a){localStorage.setItem(this.keyLists,JSON.stringify(a))},
    getName(){return localStorage.getItem(this.keyName)||''},
    setName(v){localStorage.setItem(this.keyName,v)} };
  const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
  const fmtDate=d=>new Intl.DateTimeFormat('it-IT',{dateStyle:'full',timeZone:TZ}).format(d);
  const fmtTime=d=>new Intl.DateTimeFormat('it-IT',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:TZ}).format(d);

  function toast(msg,ok=true){
    const t=document.getElementById('toast');
    t.textContent=msg;
    t.style.background=ok?'linear-gradient(160deg,rgba(26,180,109,.85),rgba(26,180,109,.65))':'linear-gradient(160deg,rgba(255,122,122,.9),rgba(255,122,122,.7))';
    t.style.color=ok?'#07140e':'#2b0f0f';
    t.style.opacity=1; t.style.transform='translateX(-50%) translateY(0)';
    setTimeout(()=>{t.style.opacity=0; t.style.transform='translateX(-50%) translateY(20px)';},1700);
  }

  /* Drawer + navigazione */
  const drawer=document.getElementById('drawer'), overlay=document.getElementById('overlay');
  document.getElementById('btnMenu').addEventListener('click',()=>{drawer.classList.add('open');overlay.classList.add('show')});
  overlay.addEventListener('click',()=>{drawer.classList.remove('open');overlay.classList.remove('show')});
  drawer.querySelectorAll('[data-go]').forEach(b=>b.addEventListener('click',()=>{
    goTo(b.getAttribute('data-go')); drawer.classList.remove('open'); overlay.classList.remove('show');
  }));
  function goTo(sel){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const t=document.querySelector(sel); if(t){t.classList.add('active');t.scrollTop=0;}
    document.querySelectorAll('.navlink').forEach(n=>n.classList.remove('active'));
    const active = drawer.querySelector(`.navlink[data-go="${sel}"]`); if(active) active.classList.add('active');
    if(sel==='#screen-all-codes') renderCodesTable();
    if(sel==='#screen-add-list'){ renderSearchResults(); renderListBuilder(); }
    if(sel==='#screen-lists') renderListsTable();
    if(sel==='#screen-export') refreshExportLists();
  }

  /* Clock */
  const bigClock=document.getElementById('bigClock'), bigDate=document.getElementById('bigDate'), smallClock=document.getElementById('appClockSmall');
  function tick(){const n=new Date();bigClock.textContent=fmtTime(n);smallClock.textContent=new Intl.DateTimeFormat('it-IT',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:TZ}).format(n);bigDate.textContent=fmtDate(n)}
  setInterval(tick,1000); tick();

  /* ===== CODICI ===== */
  const codeForm=document.getElementById('codeForm'), editBadge=document.getElementById('editBadge'), codeSavedMsg=document.getElementById('codeSavedMsg');
  const F={titolo:document.getElementById('cTitolo'),codice:document.getElementById('cCodice'),desc:document.getElementById('cDesc'),qty:document.getElementById('cQty'),unit:document.getElementById('cUnit'),extra:document.getElementById('cExtra')};
  let editingId=null;
  function fillCodeForm(it){F.titolo.value=it?.titolo||'';F.codice.value=it?.codice||'';F.desc.value=it?.descrizione||'';F.qty.value=it?.quantita??0;F.unit.value=it?.unita||'';F.extra.value=it?.extra||''}
  function resetCodeForm(){editingId=null;document.getElementById('addCodeTitle').textContent='Aggiungi codice';editBadge.style.display='none';fillCodeForm(null);codeSavedMsg.style.display='none'}
  document.getElementById('resetCodeForm').addEventListener('click',resetCodeForm);
  codeForm.addEventListener('submit',e=>{
    e.preventDefault();
    const data={titolo:F.titolo.value.trim(),codice:F.codice.value.trim(),descrizione:F.desc.value.trim(),quantita:parseInt(F.qty.value||'0',10),unita:F.unit.value.trim(),extra:F.extra.value.trim()};
    if(!data.titolo||!data.codice){toast('Titolo e Codice sono obbligatori',false);return}
    let all=Store.getCodes();
    if(!editingId && all.some(x=>(x.codice||'').toLowerCase()===data.codice.toLowerCase())){toast('Codice gi√† presente',false);return}
    if(editingId){all=all.map(x=>x.id===editingId?{...x,...data,updatedAt:Date.now()}:x)} else {all.push({id:uid(),createdAt:Date.now(),...data})}
    Store.setCodes(all); codeSavedMsg.style.display=''; toast('Codice salvato'); renderCodesTable();
    if(!editingId) fillCodeForm(null); editingId=null; document.getElementById('addCodeTitle').textContent='Aggiungi codice'; editBadge.style.display='none';
  });

  /* ===== LISTE ===== */
  const lNome=document.getElementById('lNome'), lDesc=document.getElementById('lDesc'), lSearch=document.getElementById('lSearch');
  const searchResults=document.getElementById('searchResults'), listItemsArea=document.getElementById('listItemsArea'), listSavedMsg=document.getElementById('listSavedMsg');
  let builderItems=[], listEditingId=null;
  let lastScanValue=''; // per evitare auto-aggiunte duplicate

  document.getElementById('clearListBuilder').addEventListener('click',()=>{builderItems=[];renderListBuilder(); lSearch.focus()});

  // aggiunge (o incrementa) per id codice
  function addToBuilder(codeId, qty=1){
    qty=Math.max(1,parseInt(qty||'1',10));
    const ex=builderItems.find(x=>x.codeId===codeId);
    if(ex){ex.qty+=qty}else{builderItems.push({codeId,qty})}
    renderListBuilder();
  }

  // ENTER: se match esatto => aggiungi; altrimenti se c'√® un solo risultato => aggiungi quello
  lSearch.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      const q=(lSearch.value||'').trim().toLowerCase(); if(!q) return;
      const codes=Store.getCodes();
      const exact=codes.find(c=>(c.codice||'').toLowerCase()===q);
      if(exact){ addToBuilder(exact.id,1); toast(`Aggiunto: ${exact.codice}`); lSearch.value=''; renderSearchResults(); return }
      const filtered=codes.filter(c=>(c.codice||'').toLowerCase().includes(q));
      if(filtered.length===1){ addToBuilder(filtered[0].id,1); toast(`Aggiunto: ${filtered[0].codice}`); lSearch.value=''; renderSearchResults(); }
    }
  });

  // input: mostra risultati solo se si digita; auto-aggiunta se match esatto
  lSearch.addEventListener('input',()=>{
    const q=(lSearch.value||'').trim();
    if(q && q.toLowerCase()!==lastScanValue){
      const codes=Store.getCodes();
      const exact=codes.find(c=>(c.codice||'').toLowerCase()===q.toLowerCase());
      if(exact){
        addToBuilder(exact.id,1);
        toast(`Aggiunto automaticamente: ${exact.codice}`);
        lastScanValue=q.toLowerCase();
        lSearch.value='';
      }
    }
    renderSearchResults();
  });

  function renderSearchResults(){
    const q=(lSearch.value||'').trim(); const ql=q.toLowerCase();
    const codes=Store.getCodes();

    if(!q){
      searchResults.innerHTML=`<div class="empty">Digita un <strong>codice</strong> per cercare.</div>`;
      return;
    }

    const filtered=codes.filter(c=>(c.codice||'').toLowerCase().includes(ql));
    if(!filtered.length){
      searchResults.innerHTML=`<div class="empty">Nessun materiale per il codice <strong>${escapeHTML(q)}</strong>.</div>`;
      return;
    }

    const rows=filtered.map(c=>`
      <tr>
        <td data-label="Codice"><strong>${escapeHTML(c.codice)}</strong></td>
        <td data-label="Materiale"><div>${escapeHTML(c.titolo||'')}</div></td>
        <td data-label="Unit√†" class="date">${escapeHTML(c.unita||'')}</td>
        <td data-label="Azioni" data-actions style="text-align:right">
          <input type="number" min="1" step="1" value="1" style="width:80px;margin-right:6px" id="qty_${c.id}">
          <button class="btn" data-add="${c.id}">Aggiungi</button>
        </td>
      </tr>`).join('');

    searchResults.innerHTML=`<div class="card glass">
      <div class="card-header"><h3>Risultati</h3><span class="date">${filtered.length} trovati</span></div>
      <table class="table rtable">
        <thead><tr><th>Codice</th><th>Materiale</th><th>Unit√†</th><th style="text-align:right">Azioni</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;

    searchResults.querySelectorAll('[data-add]').forEach(b=>b.addEventListener('click',()=>{
      const id=b.getAttribute('data-add'); const qEl=document.getElementById(`qty_${id}`); const qty=Math.max(1,parseInt(qEl.value||'1',10));
      addToBuilder(id,qty);
      toast('Aggiunto alla lista');
      // resta su questa pagina; non cambiare sezione
    }));
  }

  function renderListBuilder(){
    if(!builderItems.length){listItemsArea.className='mt-6 empty';listItemsArea.innerHTML='Ancora nessun materiale aggiunto.';return}
    listItemsArea.className='mt-6 card glass';
    const byId=Object.fromEntries(Store.getCodes().map(c=>[c.id,c]));
    const rows=builderItems.map(it=>{const c=byId[it.codeId]||{};return`
      <tr>
        <td data-label="Codice"><strong>${escapeHTML(c.codice||'[elim]')}</strong></td>
        <td data-label="Materiale">${escapeHTML(c.titolo||'[eliminato]')}</td>
        <td data-label="Unit√†" class="date">${escapeHTML(c.unita||'')}</td>
        <td data-label="Quantit√†" style="width:140px"><input type="number" min="1" step="1" value="${it.qty}" style="width:100%" data-qty="${it.codeId}"></td>
        <td data-label="Azioni" data-actions style="text-align:right"><button class="btn" data-del="${it.codeId}">üóëÔ∏è</button></td>
      </tr>`}).join('');
    listItemsArea.innerHTML=`<table class="table rtable"><thead><tr><th>Codice</th><th>Materiale</th><th>Unit√†</th><th>Q.t√†</th><th style="text-align:right">Azioni</th></tr></thead><tbody>${rows}</tbody></table>`;
    listItemsArea.querySelectorAll('[data-qty]').forEach(i=>i.addEventListener('change',()=>{const id=i.getAttribute('data-qty');const it=builderItems.find(x=>x.codeId===id);if(it){it.qty=Math.max(1,parseInt(i.value||'1',10))}}));
    listItemsArea.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-del');builderItems=builderItems.filter(x=>x.codeId!==id);renderListBuilder()}));
  }

  document.getElementById('listForm').addEventListener('submit',e=>{
    e.preventDefault();
    const nome=lNome.value.trim(); if(!nome){toast('Nome lista obbligatorio',false);return}
    if(builderItems.length===0){toast('Aggiungi almeno un materiale',false);return}
    let all=Store.getLists();
    if(listEditingId){
      all=all.map(l=>l.id===listEditingId?{...l,nome,descrizione:lDesc.value.trim(),items:builderItems.map(x=>({codeId:x.codeId,qty:x.qty})),updatedAt:Date.now()}:l);
      toast('Lista aggiornata');
    } else {
      all.push({id:uid(),nome,descrizione:lDesc.value.trim(),items:builderItems.map(x=>({codeId:x.codeId,qty:x.qty})),createdAt:Date.now()});
      toast('Lista salvata');
    }
    Store.setLists(all);
    // resta in "Aggiungi lista" finch√© non decidi tu di cambiare sezione:
    builderItems=[]; renderListBuilder(); listSavedMsg.style.display=''; lNome.value=''; lDesc.value=''; listEditingId=null; document.getElementById('editListBadge').style.display='none';
    refreshExportLists();
    lSearch.focus();
  });

  /* ===== Tabelle codici ===== */
  const codesSearch=document.getElementById('codesSearch'), codesTableWrap=document.getElementById('codesTableWrap'), codesCount=document.getElementById('codesCount');
  function renderCodesTable(){
    const q=(codesSearch?.value||'').toLowerCase().trim();
    const codes=Store.getCodes().sort((a,b)=>(a.titolo||'').localeCompare(b.titolo||'')); codesCount.textContent=codes.length;
    const list=q?codes.filter(c=>(c.titolo||'').toLowerCase().includes(q)||(c.codice||'').toLowerCase().includes(q)||(c.descrizione||'').toLowerCase().includes(q)):codes;
    if(!list.length){codesTableWrap.innerHTML=`<div class="empty">Nessun elemento${q?` per "<strong>${escapeHTML(q)}</strong>"`:''}.</div>`;return}
    const rows=list.map(c=>`
      <tr>
        <td data-label="Elemento"><strong>${escapeHTML(c.titolo)}</strong><div class="date">${escapeHTML(c.codice)}</div></td>
        <td data-label="Q.t√†">${escapeHTML(c.quantita??0)}</td>
        <td data-label="Unit√†">${escapeHTML(c.unita||'')}</td>
        <td data-label="Descrizione" class="date" title="${escapeHTML(c.descrizione||'')}">${escapeHTML((c.descrizione||'').slice(0,60))}${(c.descrizione||'').length>60?'‚Ä¶':''}</td>
        <td data-label="Data" class="date">${c.updatedAt?'mod. '+new Date(c.updatedAt).toLocaleDateString('it-IT'):new Date(c.createdAt).toLocaleDateString('it-IT')}</td>
        <td data-label="Azioni" data-actions style="text-align:right;white-space:nowrap">
          <button class="btn" data-edit="${c.id}">Modifica</button>
          <button class="btn" data-dup="${c.id}">Duplica</button>
          <button class="btn" data-del="${c.id}">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
    codesTableWrap.innerHTML=`<div class="card glass"><table class="table rtable"><thead><tr><th>Elemento</th><th>Q.t√†</th><th>Unit√†</th><th>Descrizione</th><th>Data</th><th style="text-align:right">Azioni</th></tr></thead><tbody>${rows}</tbody></table></div>`;
    codesTableWrap.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-edit');const it=Store.getCodes().find(x=>x.id===id);if(!it)return;fillCodeForm(it);editingId=id;document.getElementById('addCodeTitle').textContent='Modifica codice';editBadge.style.display='';goTo('#screen-add-code')}));
    codesTableWrap.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-del');if(!confirm('Eliminare questo codice?'))return;Store.setCodes(Store.getCodes().filter(x=>x.id!==id));toast('Codice eliminato');renderCodesTable()}));
    codesTableWrap.querySelectorAll('[data-dup]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-dup');const c=Store.getCodes().find(x=>x.id===id);if(!c)return;const cp={...c,id:uid(),codice:c.codice+'-COPY',createdAt:Date.now(),updatedAt:undefined};const all=Store.getCodes();all.push(cp);Store.setCodes(all);toast('Duplicato creato');renderCodesTable()}));
  }
  codesSearch && codesSearch.addEventListener('input',renderCodesTable);

  /* ===== Liste salvate & Export ===== */
  const listsSearch=document.getElementById('listsSearch'), listsTableWrap=document.getElementById('listsTableWrap'), listsCount=document.getElementById('listsCount');
  function itemsCount(items){return items.reduce((a,b)=>a+(parseInt(b.qty||'0',10)||0),0)}
  function renderListsTable(){
    const q=(listsSearch?.value||'').toLowerCase().trim();
    const lists=Store.getLists().sort((a,b)=>(a.nome||'').localeCompare(b.nome||'')); listsCount.textContent=lists.length;
    const filtered=q?lists.filter(l=>(l.nome||'').toLowerCase().includes(q)||(l.descrizione||'').toLowerCase().includes(q)):lists;
    if(!filtered.length){listsTableWrap.innerHTML=`<div class="empty">Nessuna lista${q?` per "<strong>${escapeHTML(q)}</strong>"`:''}.</div>`;return}
    const codes=Object.fromEntries(Store.getCodes().map(c=>[c.id,c]));
    const rows=filtered.map(l=>{
      const det=(l.items||[]).map((it,i)=>{const c=codes[it.codeId]||{};return`<tr>
        <td data-label="#">${i+1}</td>
        <td data-label="Materiale"><strong>${escapeHTML(c.titolo||'[eliminato]')}</strong><div class="date">${escapeHTML(c.codice||'')}</div></td>
        <td data-label="Unit√†">${escapeHTML(c.unita||'')}</td>
        <td data-label="Q.t√†" style="text-align:right">${it.qty}</td>
        <td data-label="Descrizione" class="date">${escapeHTML((c.descrizione||'').slice(0,120))}${(c.descrizione||'').length>120?'‚Ä¶':''}</td>
      </tr>`}).join('');
      const meta=l.updatedAt?('mod. '+new Date(l.updatedAt).toLocaleDateString('it-IT')):new Date(l.createdAt).toLocaleDateString('it-IT');
      return `<tbody data-list="${l.id}">
        <tr>
          <td data-label="Dettagli" style="width:36px"><button class="btn" data-toggle="${l.id}">‚ñº</button></td>
          <td data-label="Lista"><strong>${escapeHTML(l.nome)}</strong><div class="date">${escapeHTML(l.descrizione||'')}</div></td>
          <td data-label="Righe">${(l.items||[]).length}</td>
          <td data-label="Pezzi">${itemsCount(l.items||[])}</td>
          <td data-label="Data" class="date">${meta}</td>
          <td data-label="Azioni" data-actions style="text-align:right;white-space:nowrap">
            <button class="btn" data-edit-list="${l.id}">Modifica</button>
            <button class="btn" data-del-list="${l.id}">üóëÔ∏è</button>
          </td>
        </tr>
        <tr class="subrow" id="sub_${l.id}" style="display:none">
          <td></td><td colspan="5">
            <table class="table rtable"><thead><tr><th>#</th><th>Materiale</th><th>Unit√†</th><th style="text-align:right">Q.t√†</th><th>Descrizione</th></tr></thead><tbody>${det||'<tr><td colspan="5" class="date">Nessun elemento</td></tr>'}</tbody></table>
          </td>
        </tr>
      </tbody>`}).join('');
    listsTableWrap.innerHTML=`<div class="card glass"><table class="table rtable"><thead><tr><th></th><th>Lista</th><th>Righe</th><th>Pezzi</th><th>Data</th><th style="text-align:right">Azioni</th></tr></thead>${rows}</table></div>`;
    listsTableWrap.querySelectorAll('[data-toggle]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-toggle');const r=document.getElementById(`sub_${id}`);if(r){r.style.display=r.style.display==='none'?'':'none'}}));
    listsTableWrap.querySelectorAll('[data-del-list]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-del-list');if(!confirm('Eliminare questa lista?'))return;Store.setLists(Store.getLists().filter(l=>l.id!==id));toast('Lista eliminata');renderListsTable();refreshExportLists()}));
    listsTableWrap.querySelectorAll('[data-edit-list]').forEach(b=>b.addEventListener('click',()=>{const id=b.getAttribute('data-edit-list');const l=Store.getLists().find(x=>x.id===id);if(!l)return;document.getElementById('lNome').value=l.nome||'';document.getElementById('lDesc').value=l.descrizione||'';builderItems=(l.items||[]).map(it=>({codeId:String(it.codeId||''),qty:Math.max(1,parseInt(it.qty||'1',10))}));listEditingId=l.id;document.getElementById('editListBadge').style.display='';renderListBuilder();goTo('#screen-add-list')}));
  }
  listsSearch && listsSearch.addEventListener('input',renderListsTable);

  /* Export/Import */
  const listSelectExport=document.getElementById('listSelectExport'); const btnExportPDF=document.getElementById('btnExportPDF'); const btnExportJSON=document.getElementById('btnExportJSON'); const fileImportJSON=document.getElementById('fileImportJSON'); const btnWipeAll=document.getElementById('btnWipeAll');
  function refreshExportLists(){const lists=Store.getLists().sort((a,b)=>(a.nome||'').localeCompare(b.nome||''));listSelectExport.innerHTML=lists.length?lists.map(l=>`<option value="${l.id}">${escapeHTML(l.nome)}</option>`).join(''):`<option value="">(Nessuna lista)</option>`}
  refreshExportLists();

  btnExportJSON.addEventListener('click',()=>{
    const payload={exportedAt:new Date().toISOString(),app:'Gestione Materiali Glass',name:Store.getName(),codes:Store.getCodes(),lists:Store.getLists()};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);
    const a=Object.assign(document.createElement('a'),{href:url,download:`gestione-materiali_${Date.now()}.json`});document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);toast('JSON esportato');
  });

  btnExportPDF.addEventListener('click',()=>{
    const listId=listSelectExport.value; const lists=Store.getLists(); const codes=Object.fromEntries(Store.getCodes().map(c=>[c.id,c])); const l=lists.find(x=>x.id===listId);
    if(!l){toast('Seleziona una lista',false);return}
    const rows=l.items.map((it,i)=>{const c=codes[it.codeId]||{};return `<tr>
      <td style="padding:6px 10px;border:1px solid #ccc">${i+1}</td>
      <td style="padding:6px 10px;border:1px solid #ccc"><strong>${escapeHTML(c.titolo||'[eliminato]')}</strong><div style="color:#555;font-size:12px">${escapeHTML(c.codice||'')}</div></td>
      <td style="padding:6px 10px;border:1px solid #ccc">${escapeHTML(c.unita||'')}</td>
      <td style="padding:6px 10px;border:1px solid #ccc;text-align:right">${it.qty}</td>
      <td style="padding:6px 10px;border:1px solid #ccc">${escapeHTML(c.descrizione||'')}</td>`}).join('');
    const dateStr=new Date().toLocaleString('it-IT',{timeZone:'Europe/Rome'}); const user=Store.getName()||'';
    const html=`<html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Lista - ${escapeHTML(l.nome)}</title>
      <style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#111}h1{margin:0 0 6px}h2{margin:4px 0 18px;font-size:14px;color:#444}
      table{border-collapse:collapse;width:100%}th,td{border:1px solid #ccc;padding:6px 10px}th{text-align:left}.meta{margin-bottom:12px;color:#444;font-size:13px}</style>
      </head><body><h1>Esportazione lista</h1><h2>${escapeHTML(l.nome)}</h2>
      <div class="meta">Tecnico: <strong>${escapeHTML(user)}</strong> ¬∑ Data: ${escapeHTML(dateStr)}${l.descrizione?' ¬∑ Note: '+escapeHTML(l.descrizione):''}</div>
      <table><thead><tr><th style="width:40px">#</th><th>Materiale</th><th style="width:90px">Unit√†</th><th style="width:80px;text-align:right">Q.t√†</th><th>Descrizione</th></tr></thead><tbody>${rows}</tbody></table>
      <script>window.addEventListener('load',()=>setTimeout(()=>window.print(),50));<\/script></body></html>`;
    const win=window.open('','_blank'); if(win&&win.document){win.document.open();win.document.write(html);win.document.close()}
    else{const iframe=document.createElement('iframe');Object.assign(iframe.style,{position:'fixed',right:'0',bottom:'0',width:'0',height:'0',border:'0'});document.body.appendChild(iframe);iframe.contentDocument.open();iframe.contentDocument.write(html);iframe.contentDocument.close();iframe.onload=()=>iframe.contentWindow&&iframe.contentWindow.print()}
  });

  fileImportJSON.addEventListener('change',async e=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const text=await f.text(); const data=JSON.parse(text);
      if(!confirm('Importare i dati dal file? Sostituir√† i dati correnti.')) return;
      if(!Array.isArray(data.codes)||!Array.isArray(data.lists)) throw new Error('Formato non valido');
      Store.setCodes(sanitizeCodes(data.codes)); Store.setLists(sanitizeLists(data.lists));
      if(typeof data.name==='string'){Store.setName(data.name)}
      toast('Dati importati'); renderCodesTable(); renderListBuilder(); renderSearchResults(); renderListsTable(); refreshExportLists();
    }catch(err){console.error(err);toast('Errore durante l‚Äôimportazione',false)} finally{e.target.value=''}
  });

  btnWipeAll.addEventListener('click',()=>{if(!confirm('Eliminare TUTTI i dati locali?')) return; localStorage.removeItem(Store.keyCodes); localStorage.removeItem(Store.keyLists); renderCodesTable(); refreshExportLists(); renderListsTable(); toast('Archivio svuotato')});

  function sanitizeCodes(arr){return arr.filter(x=>x&&typeof x==='object').map(x=>({id:x.id||uid(),titolo:String(x.titolo||''),codice:String(x.codice||''),descrizione:String(x.descrizione||''),quantita:Number.isFinite(+x.quantita)?+x.quantita:0,unita:String(x.unita||''),extra:String(x.extra||''),createdAt:Number.isFinite(+x.createdAt)?+x.createdAt:Date.now(),updatedAt:Number.isFinite(+x.updatedAt)?+x.updatedAt:undefined}))}
  function sanitizeLists(arr){return arr.filter(x=>x&&typeof x==='object').map(x=>({id:x.id||uid(),nome:String(x.nome||''),descrizione:String(x.descrizione||''),items:Array.isArray(x.items)?x.items.map(it=>({codeId:String(it.codeId||''),qty:Math.max(1,parseInt(it.qty||'1',10))})):[],createdAt:Number.isFinite(+x.createdAt)?+x.createdAt:Date.now(),updatedAt:Number.isFinite(+x.updatedAt)?+x.updatedAt:undefined}))}
  function escapeHTML(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}

  // Init
  renderCodesTable(); renderSearchResults(); renderListBuilder(); refreshExportLists(); renderListsTable();
</script>
</body>
</html>

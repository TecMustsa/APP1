<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Materiali ‚Äî Effetto Glass</title>
<style>
  :root{
    --bg: radial-gradient(1200px 800px at 10% 10%, #1b1f2a 0%, #0e1117 55%, #0b0d12 100%);
    --card: rgba(255,255,255,0.08);
    --card-strong: rgba(255,255,255,0.12);
    --stroke: rgba(255,255,255,0.18);
    --text: #e7eaf1;
    --muted: #a8b0c0;
    --accent: #7aa2ff;
    --ok: #62d18a;
    --warn: #ffcc66;
    --danger: #ff7a7a;
    --shadow: 0 10px 30px rgba(0,0,0,0.35);
    --radius: 16px;
    --radius-sm: 12px;
    --radius-lg: 22px;
    --blur: 16px;
  }

  /* Reset minimale */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: var(--bg);
    color: var(--text);
    overflow-x: hidden;
  }
  a{color:var(--accent); text-decoration:none}
  button{cursor:pointer}

  /* Layout */
  .app{
    display:grid;
    grid-template-rows: 64px 1fr;
    min-height:100dvh;
  }
  header.appbar{
    position:sticky; top:0; z-index:20;
    display:flex; align-items:center; gap:12px;
    padding:0 14px;
    background: linear-gradient( to bottom, rgba(12,14,19,0.80), rgba(12,14,19,0.35) );
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--stroke);
  }
  .hamburger{
    width:44px; height:44px; display:grid; place-items:center;
    border-radius: 10px; border:1px solid var(--stroke);
    background: var(--card);
    backdrop-filter: blur(var(--blur));
    box-shadow: var(--shadow);
  }
  .hamburger .bars{
    display:grid; gap:4px;
  }
  .hamburger .bars span{
    display:block; width:18px; height:2px; background:#e6ebff; border-radius:2px;
  }
  .brand{
    font-weight:700; letter-spacing:.3px;
  }
  .grow{flex:1}
  .appmain{
    position:relative;
    padding:28px clamp(16px, 4vw, 40px) 40px;
  }

  /* Drawer (menu laterale) */
  .drawer{
    position: fixed; inset:0 30% 0 auto; width:min(320px, 85vw);
    transform: translateX(-100%);
    transition: transform .28s ease;
    z-index:1000;
  }
  .drawer.open{ transform: translateX(0) }
  .drawer-panel{
    position:absolute; inset:0 auto 0 0;
    height:100%;
    background: linear-gradient(180deg, rgba(30,34,46,0.7), rgba(18,20,28,0.7));
    border-right:1px solid var(--stroke);
    backdrop-filter: blur(18px);
    box-shadow: var(--shadow);
    padding:18px 14px;
    display:flex; flex-direction:column; gap:10px;
  }
  .drawer .title{
    font-size:14px; text-transform:uppercase; letter-spacing:.18em; color:var(--muted);
    margin:6px 8px 2px;
  }
  .navlink{
    display:flex; align-items:center; gap:10px;
    padding:12px 12px; border-radius:12px;
    border:1px solid transparent;
    background: transparent;
    color:var(--text);
  }
  .navlink:hover{ background: var(--card); border-color:var(--stroke) }
  .navlink.active{ background: var(--card-strong); border-color:var(--stroke) }
  .nav-bottom{ margin-top:auto; border-top:1px dashed var(--stroke); padding-top:10px }
  .icon{
    width:20px; height:20px; display:inline-grid; place-items:center; opacity:.9;
  }
  .overlay{
    position: fixed; inset:0; background: rgba(0,0,0,0.35); backdrop-filter: blur(2px);
    opacity:0; pointer-events:none; transition: opacity .25s ease; z-index:900;
  }
  .overlay.show{ opacity:1; pointer-events:auto }

  /* Schermate/Sezioni */
  .screen{ display:none; animation: fade .22s ease both }
  .screen.active{ display:block }
  @keyframes fade{ from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none} }

  /* Card glass */
  .card{
    background: var(--card);
    border:1px solid var(--stroke);
    backdrop-filter: blur(var(--blur));
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding:18px;
  }
  .card-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px }
  .card h2, .card h3{ margin:0; font-weight:700; letter-spacing:.2px }

  /* Home */
  .home-wrap{
    display:grid; gap:18px;
    max-width: 1000px; margin: 0 auto;
    grid-template-columns: 1fr;
  }
  .welcome-card{
    display:grid; gap:6px; text-align:center; padding:30px;
  }
  .welcome-card em{ font-style: italic; font-size: clamp(22px, 4vw, 30px); color:#d7defa }
  .clock{ font-size: clamp(28px, 6vw, 48px); font-weight:800; line-height:1.2 }
  .date{ color: var(--muted); font-size: clamp(14px, 2.3vw, 18px) }
  .name-row{
    display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:6px
  }
  .name-row input{
    min-width:220px; max-width:340px; text-align:center;
  }

  /* Form di base */
  form .grid{
    display:grid; gap:12px;
    grid-template-columns: repeat(12, 1fr);
  }
  .field{ display:grid; gap:8px }
  .field label{ color: var(--muted); font-size:12px; letter-spacing:.06em; text-transform:uppercase }
  .field input, .field textarea, .field select{
    width:100%; border-radius:12px; border:1px solid var(--stroke);
    background: rgba(255,255,255,0.06); color: var(--text);
    padding:12px 12px; outline:none;
  }
  .field textarea{ min-height:100px; resize: vertical }
  .actions{ display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end; margin-top:8px }
  .btn{
    border:1px solid var(--stroke); background: var(--card-strong); color:var(--text);
    padding:10px 14px; border-radius:12px; font-weight:600;
  }
  .btn.primary{ background: linear-gradient(180deg, rgba(86,132,255,0.9), rgba(86,132,255,0.65)); border-color: rgba(86,132,255,0.8) }
  .btn.ghost{ background: transparent }
  .btn.warn{ background: linear-gradient(180deg, rgba(255,204,102,0.9), rgba(255,204,102,0.65)); color:#1b1608; border-color: rgba(255,204,102,0.8) }
  .btn.danger{ background: linear-gradient(180deg, rgba(255,122,122,0.9), rgba(255,122,122,0.65)); color:#1b0c0c; border-color: rgba(255,122,122,0.8) }

  /* Tabelle e liste */
  .table{
    width:100%; border-collapse: collapse; font-size: 14px; overflow:auto
  }
  .table thead th{
    position:sticky; top:0;
    text-align:left; padding:10px; background: rgba(255,255,255,0.06);
    border-bottom:1px solid var(--stroke);
  }
  .table td{ padding:10px; border-bottom:1px dashed var(--stroke) }
  .muted{ color:var(--muted) }
  .empty{
    padding:18px; text-align:center; color:var(--muted);
    border:1px dashed var(--stroke); border-radius:12px; background: rgba(255,255,255,0.04)
  }

  /* Pill/Tag */
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; font-size:12px;
    border:1px solid var(--stroke); background: rgba(255,255,255,0.06)
  }

  /* Toaster */
  .toast{
    position: fixed; left:50%; bottom:24px; transform: translateX(-50%) translateY(20px);
    opacity:0; transition: .25s ease;
    background: rgba(26,180,109,0.9); color:#08140e; border:1px solid rgba(26,180,109,0.9);
    padding:12px 16px; border-radius: 12px; box-shadow: var(--shadow); z-index:2000;
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(0) }

  /* Utility */
  .mt-6{ margin-top:6px } .mt-10{ margin-top:10px } .mt-16{ margin-top:16px }
  .col-12{ grid-column: span 12 } .col-6{ grid-column: span 6 } .col-4{ grid-column: span 4 } .col-3{ grid-column: span 3 } .col-8{ grid-column: span 8 }
  @media (max-width:840px){
    .col-6,.col-4,.col-3,.col-8{ grid-column: span 12 }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Barra superiore -->
  <header class="appbar">
    <button id="btnMenu" class="hamburger" aria-label="Apri menu">
      <span class="bars" aria-hidden="true">
        <span></span><span></span><span></span>
      </span>
    </button>
    <div class="brand">Gestione Materiali ¬∑ Glass</div>
    <div class="grow"></div>
    <div class="pill"><span class="icon" aria-hidden="true">üïò</span><span id="appClockSmall">--:--</span></div>
  </header>

  <!-- Contenuto -->
  <main class="appmain">
    <!-- HOME -->
    <section id="screen-home" class="screen active">
      <div class="home-wrap">
        <div class="card welcome-card">
          <em>Benvenuto tecnico</em>
          <div class="clock" id="bigClock">--:--:--</div>
          <div class="date" id="bigDate">‚Äî ‚Äî</div>
          <div class="name-row">
            <input id="inputName" class="card" style="padding:10px 14px" placeholder="Inserisci il tuo nome‚Ä¶" />
            <button class="btn primary" id="saveNameBtn">Salva nome</button>
          </div>
          <div class="muted" id="helloName" aria-live="polite"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Collegamenti rapidi</h3>
          </div>
          <div class="actions" style="justify-content:center">
            <button class="btn" data-go="#screen-add-code">‚ûï Aggiungi codice</button>
            <button class="btn" data-go="#screen-add-list">üìù Aggiungi lista</button>
            <button class="btn" data-go="#screen-all-codes">üìö Tutti i codici</button>
            <button class="btn" data-go="#screen-export">‚§¥Ô∏è Esportazione</button>
          </div>
        </div>
      </div>
    </section>

    <!-- AGGIUNGI CODICE -->
    <section id="screen-add-code" class="screen">
      <div class="card">
        <div class="card-header">
          <h2 id="codeFormTitle">Aggiungi codice</h2>
          <span class="pill" id="editBadge" style="display:none">Modalit√† modifica</span>
        </div>
        <form id="codeForm">
          <div class="grid">
            <div class="field col-6">
              <label for="cTitolo">Titolo</label>
              <input id="cTitolo" required placeholder="Es. Cavo multipolare 3x1.5" />
            </div>
            <div class="field col-6">
              <label for="cCodice">Codice</label>
              <input id="cCodice" required placeholder="Es. ART-00123" />
            </div>
            <div class="field col-12">
              <label for="cDesc">Descrizione</label>
              <textarea id="cDesc" placeholder="Dettagli, note tecniche, marca‚Ä¶"></textarea>
            </div>
            <div class="field col-4">
              <label for="cQty">Quantit√†</label>
              <input id="cQty" type="number" min="0" step="1" value="0" />
            </div>
            <div class="field col-4">
              <label for="cUnit">Unit√† di misura</label>
              <input id="cUnit" placeholder="pz, m, kg‚Ä¶" />
            </div>
            <div class="field col-4">
              <label for="cExtra">Note (opz.)</label>
              <input id="cExtra" placeholder="Colore, lotto‚Ä¶" />
            </div>
          </div>
          <div class="actions">
            <button type="button" class="btn ghost" id="resetCodeForm">Annulla</button>
            <button type="submit" class="btn primary" id="saveCodeBtn">Salva codice</button>
          </div>
          <div class="mt-10 muted" id="codeSavedMsg" style="display:none">‚úÖ Codice salvato.</div>
        </form>
      </div>
    </section>

    <!-- AGGIUNGI LISTA -->
    <section id="screen-add-list" class="screen">
      <div class="card">
        <div class="card-header">
          <h2>Aggiungi lista</h2>
        </div>
        <form id="listForm">
          <div class="grid">
            <div class="field col-6">
              <label for="lNome">Nome lista</label>
              <input id="lNome" required placeholder="Es. Quadro elettrico cantiere" />
            </div>
            <div class="field col-6">
              <label for="lDesc">Descrizione (opz.)</label>
              <input id="lDesc" placeholder="Obiettivo, cliente, luogo‚Ä¶" />
            </div>
          </div>
          <div class="grid mt-16">
            <div class="field col-12">
              <label for="lSearch">Cerca materiale</label>
              <input id="lSearch" placeholder="Cerca per titolo, codice o descrizione‚Ä¶" />
            </div>
          </div>
          <div class="mt-10" id="searchResults"></div>

          <div class="mt-16">
            <h3>Elenco della lista</h3>
            <div id="listItemsArea" class="mt-6 empty">Ancora nessun materiale aggiunto.</div>
          </div>

          <div class="actions mt-16">
            <button type="button" class="btn ghost" id="clearListBuilder">Svuota</button>
            <button type="submit" class="btn primary">Salva lista</button>
          </div>
          <div class="mt-10 muted" id="listSavedMsg" style="display:none">‚úÖ Lista salvata.</div>
        </form>
      </div>
    </section>

    <!-- TUTTI I CODICI -->
    <section id="screen-all-codes" class="screen">
      <div class="card">
        <div class="card-header">
          <h2>Tutti i codici</h2>
          <div class="actions">
            <button class="btn" data-go="#screen-add-code">‚ûï Nuovo</button>
          </div>
        </div>
        <div class="grid">
          <div class="field col-8">
            <label for="codesSearch">Filtra</label>
            <input id="codesSearch" placeholder="Digita per filtrare per titolo/codice‚Ä¶" />
          </div>
          <div class="field col-4">
            <label>&nbsp;</label>
            <div class="pill"><span class="icon">üì¶</span><span id="codesCount">0</span> elementi</div>
          </div>
        </div>
        <div class="mt-10" id="codesTableWrap">
          <div class="empty">Non ci sono codici. Aggiungi il primo dalla sezione <strong>Aggiungi codice</strong>.</div>
        </div>
      </div>
    </section>

    <!-- ESPORTAZIONE -->
    <section id="screen-export" class="screen">
      <div class="card">
        <div class="card-header">
          <h2>Esportazione</h2>
        </div>
        <div class="grid">
          <div class="field col-12">
            <label for="listSelectExport">Seleziona una lista da esportare in PDF</label>
            <select id="listSelectExport"></select>
          </div>
        </div>
        <div class="actions mt-10">
          <button class="btn primary" id="btnExportPDF">üßæ Esporta lista in PDF</button>
          <button class="btn" id="btnExportJSON">‚¨áÔ∏è Esporta dati in JSON (compatibile Gson)</button>
          <label class="btn warn" for="fileImportJSON" style="display:inline-block">‚¨ÜÔ∏è Importa dati da JSON</label>
          <input id="fileImportJSON" type="file" accept=".json,application/json" style="display:none" />
          <button class="btn danger" id="btnWipeAll">üóëÔ∏è Cancella TUTTO (local)</button>
        </div>
        <p class="muted mt-10">
          Tutti i dati vengono salvati <strong>solo</strong> nel tuo browser (localStorage). L‚Äôesportazione JSON include codici e liste.
        </p>
      </div>
    </section>
  </main>
</div>

<!-- Drawer (hamburger) -->
<div class="drawer" id="drawer">
  <div class="drawer-panel" role="dialog" aria-label="Menu">
    <div class="title">Navigazione</div>
    <button class="navlink" data-go="#screen-home"><span class="icon">üè†</span>Home</button>
    <button class="navlink" data-go="#screen-add-code"><span class="icon">‚ûï</span>Aggiungi codice</button>
    <button class="navlink" data-go="#screen-add-list"><span class="icon">üìù</span>Aggiungi lista</button>
    <button class="navlink" data-go="#screen-all-codes"><span class="icon">üìö</span>Tutti i codici</button>
    <div class="nav-bottom">
      <button class="navlink" data-go="#screen-export"><span class="icon">‚§¥Ô∏è</span>Esportazione</button>
    </div>
  </div>
</div>
<div class="overlay" id="overlay"></div>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  /***************************
   * UTILIT√Ä & STORAGE
   ***************************/
  const TZ = 'Europe/Rome';

  const Store = {
    keyCodes: 'gm_codes_v1',
    keyLists: 'gm_lists_v1',
    keyName:  'gm_username_v1',
    getCodes(){ return JSON.parse(localStorage.getItem(this.keyCodes) || '[]'); },
    setCodes(arr){ localStorage.setItem(this.keyCodes, JSON.stringify(arr)); },
    getLists(){ return JSON.parse(localStorage.getItem(this.keyLists) || '[]'); },
    setLists(arr){ localStorage.setItem(this.keyLists, JSON.stringify(arr)); },
    getName(){ return localStorage.getItem(this.keyName) || ''; },
    setName(v){ localStorage.setItem(this.keyName, v); }
  };

  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
  const fmtDate = (d) => new Intl.DateTimeFormat('it-IT', {dateStyle:'full', timeZone:TZ}).format(d);
  const fmtTime = (d) => new Intl.DateTimeFormat('it-IT', {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone:TZ}).format(d);

  function toast(msg, ok=true){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.background = ok ? 'rgba(26,180,109,0.9)' : 'rgba(255,122,122,0.95)';
    t.style.borderColor = ok ? 'rgba(26,180,109,0.9)' : 'rgba(255,122,122,0.95)';
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 1800);
  }

  /***************************
   * NAVIGAZIONE / DRAWER
   ***************************/
  const drawer = document.getElementById('drawer');
  const overlay = document.getElementById('overlay');
  const btnMenu = document.getElementById('btnMenu');

  function openDrawer(){ drawer.classList.add('open'); overlay.classList.add('show'); }
  function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); }

  btnMenu.addEventListener('click', openDrawer);
  overlay.addEventListener('click', closeDrawer);
  drawer.querySelectorAll('[data-go]').forEach(el=>{
    el.addEventListener('click', ev=>{
      goTo(el.getAttribute('data-go'));
      closeDrawer();
    });
  });

  function goTo(selector){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    const target = document.querySelector(selector);
    if(target){ target.classList.add('active'); }
    document.querySelectorAll('.navlink').forEach(n => n.classList.remove('active'));
    document.querySelectorAll(\`.navlink[data-go="\${selector}"]\`).forEach(n => n.classList.add('active'));
    // Aggiorna viste dinamiche quando navighiamo
    if(selector==='#screen-all-codes') renderCodesTable();
    if(selector==='#screen-add-list') { renderSearchResults(); renderListBuilder(); }
    if(selector==='#screen-export') refreshExportLists();
  }

  // Collegamenti rapidi
  document.querySelectorAll('[data-go]').forEach(btn=>{
    if(!btn.closest('.drawer-panel')){ // evita doppio bind
      btn.addEventListener('click', ()=> goTo(btn.getAttribute('data-go')));
    }
  });

  /***************************
   * OROLOGI & HOME
   ***************************/
  const bigClock = document.getElementById('bigClock');
  const bigDate = document.getElementById('bigDate');
  const appClockSmall = document.getElementById('appClockSmall');
  function tick(){
    const now = new Date();
    bigClock.textContent = fmtTime(now);
    appClockSmall.textContent = new Intl.DateTimeFormat('it-IT', {hour:'2-digit', minute:'2-digit', hour12:false, timeZone:TZ}).format(now);
    bigDate.textContent = fmtDate(now);
  }
  setInterval(tick, 1000); tick();

  // Nome utente
  const inputName = document.getElementById('inputName');
  const helloName = document.getElementById('helloName');
  document.getElementById('saveNameBtn').addEventListener('click', ()=>{
    Store.setName(inputName.value.trim());
    updateHello();
    toast('Nome salvato');
  });
  function updateHello(){
    const n = Store.getName();
    inputName.value = n;
    helloName.textContent = n ? \`Ciao, \${n}!\` : '';
  }
  updateHello();

  /***************************
   * AGGIUNGI / MODIFICA CODICE
   ***************************/
  const codeForm = document.getElementById('codeForm');
  const codeSavedMsg = document.getElementById('codeSavedMsg');
  const editBadge = document.getElementById('editBadge');
  const codeFormTitle = document.getElementById('codeFormTitle');
  const resetCodeFormBtn = document.getElementById('resetCodeForm');
  const fields = {
    titolo: document.getElementById('cTitolo'),
    codice: document.getElementById('cCodice'),
    desc: document.getElementById('cDesc'),
    qty: document.getElementById('cQty'),
    unit: document.getElementById('cUnit'),
    extra: document.getElementById('cExtra'),
  };
  let editingId = null;

  function fillCodeForm(item){
    fields.titolo.value = item?.titolo || '';
    fields.codice.value = item?.codice || '';
    fields.desc.value = item?.descrizione || '';
    fields.qty.value = item?.quantita ?? 0;
    fields.unit.value = item?.unita || '';
    fields.extra.value = item?.extra || '';
  }
  function resetCodeForm(){
    editingId = null;
    codeFormTitle.textContent = 'Aggiungi codice';
    editBadge.style.display = 'none';
    fillCodeForm(null);
    codeSavedMsg.style.display = 'none';
  }
  resetCodeFormBtn.addEventListener('click', resetCodeForm);

  codeForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const data = {
      titolo: fields.titolo.value.trim(),
      codice: fields.codice.value.trim(),
      descrizione: fields.desc.value.trim(),
      quantita: parseInt(fields.qty.value || '0', 10),
      unita: fields.unit.value.trim(),
      extra: fields.extra.value.trim(),
    };
    if(!data.titolo || !data.codice){
      toast('Titolo e Codice sono obbligatori', false); return;
    }
    let all = Store.getCodes();

    // impedisci duplicato codice se stiamo creando nuovo
    if(!editingId && all.some(x => x.codice.toLowerCase() === data.codice.toLowerCase())){
      toast('Esiste gi√† un elemento con lo stesso "Codice".', false);
      return;
    }

    if(editingId){
      all = all.map(x => x.id === editingId ? {...x, ...data, updatedAt: Date.now()} : x);
    }else{
      all.push({ id: uid(), createdAt: Date.now(), ...data });
    }
    Store.setCodes(all);
    codeSavedMsg.style.display = '';
    toast('Codice salvato');
    renderCodesTable(); // aggiorna elenco se serve
    if(!editingId) fillCodeForm(null);
    editingId = null;
    codeFormTitle.textContent = 'Aggiungi codice';
    editBadge.style.display = 'none';
  });

  /***************************
   * LISTA: BUILDER + SEARCH
   ***************************/
  const listForm = document.getElementById('listForm');
  const listSavedMsg = document.getElementById('listSavedMsg');
  const lNome = document.getElementById('lNome');
  const lDesc = document.getElementById('lDesc');
  const lSearch = document.getElementById('lSearch');
  const searchResults = document.getElementById('searchResults');
  const listItemsArea = document.getElementById('listItemsArea');
  const clearListBuilderBtn = document.getElementById('clearListBuilder');

  let builderItems = []; // {codeId, qty}

  function renderSearchResults(){
    const q = (lSearch.value || '').toLowerCase().trim();
    const codes = Store.getCodes();
    const filtered = q ? codes.filter(c =>
      (c.titolo||'').toLowerCase().includes(q) ||
      (c.codice||'').toLowerCase().includes(q) ||
      (c.descrizione||'').toLowerCase().includes(q)
    ) : codes.slice(0, 20);
    if(!codes.length){
      searchResults.innerHTML = `<div class="empty">Non hai ancora inserito codici.</div>`;
      return;
    }
    if(!filtered.length){
      searchResults.innerHTML = `<div class="empty">Nessun risultato per <strong>${q}</strong>.</div>`;
      return;
    }
    const rows = filtered.map(c => `
      <tr>
        <td><strong>${escapeHTML(c.titolo)}</strong><div class="muted">${escapeHTML(c.codice)}</div></td>
        <td class="muted">${escapeHTML(c.unita || '')}</td>
        <td class="muted" title="${escapeHTML(c.descrizione||'')}">${escapeHTML((c.descrizione||'').slice(0,60))}${(c.descrizione||'').length>60?'‚Ä¶':''}</td>
        <td style="text-align:right">
          <input type="number" min="1" step="1" value="1" style="width:70px; margin-right:6px" id="qty_${c.id}">
          <button class="btn" data-add="${c.id}">Aggiungi</button>
        </td>
      </tr>
    `).join('');
    searchResults.innerHTML = `
      <div class="card">
        <div class="card-header"><h3>Risultati</h3><span class="muted">${filtered.length} trovati</span></div>
        <div style="max-height:340px; overflow:auto">
          <table class="table">
            <thead><tr><th>Materiale</th><th>Unit√†</th><th>Descrizione</th><th style="text-align:right">Azioni</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
    // bind add
    searchResults.querySelectorAll('[data-add]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-add');
        const qEl = document.getElementById(`qty_${id}`);
        const qty = Math.max(1, parseInt(qEl.value||'1',10));
        const exists = builderItems.find(x=>x.codeId===id);
        if(exists){ exists.qty += qty; } else { builderItems.push({codeId:id, qty}); }
        renderListBuilder();
        toast('Aggiunto alla lista');
      });
    });
  }

  function renderListBuilder(){
    if(!builderItems.length){
      listItemsArea.className = 'mt-6 empty';
      listItemsArea.innerHTML = 'Ancora nessun materiale aggiunto.';
      return;
    }
    listItemsArea.className = 'mt-6 card';
    const codesById = Object.fromEntries(Store.getCodes().map(c=>[c.id,c]));
    const rows = builderItems.map(item=>{
      const c = codesById[item.codeId] || {};
      return `
        <tr>
          <td><strong>${escapeHTML(c.titolo||'[eliminato]')}</strong><div class="muted">${escapeHTML(c.codice||'')}</div></td>
          <td class="muted">${escapeHTML(c.unita||'')}</td>
          <td style="width:140px">
            <input type="number" min="1" step="1" value="${item.qty}" style="width:100%" data-qty="${item.codeId}">
          </td>
          <td style="text-align:right">
            <button class="btn ghost" title="Rimuovi" data-del="${item.codeId}">üóëÔ∏è</button>
          </td>
        </tr>
      `;
    }).join('');
    listItemsArea.innerHTML = `
      <div style="max-height:360px; overflow:auto">
        <table class="table">
          <thead><tr><th>Materiale</th><th>Unit√†</th><th>Quantit√†</th><th style="text-align:right">Azioni</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    // bind qty & delete
    listItemsArea.querySelectorAll('[data-qty]').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const id = inp.getAttribute('data-qty');
        const it = builderItems.find(x=>x.codeId===id);
        if(it){ it.qty = Math.max(1, parseInt(inp.value||'1',10)); }
      });
    });
    listItemsArea.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-del');
        builderItems = builderItems.filter(x=>x.codeId!==id);
        renderListBuilder();
      });
    });
  }

  lSearch.addEventListener('input', renderSearchResults);
  clearListBuilderBtn.addEventListener('click', ()=>{
    builderItems = [];
    renderListBuilder();
  });

  listForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const nome = lNome.value.trim();
    if(!nome){ toast('Il nome della lista √® obbligatorio', false); return; }
    if(builderItems.length===0){ toast('Aggiungi almeno un materiale', false); return; }
    const lista = {
      id: uid(),
      nome,
      descrizione: lDesc.value.trim(),
      items: builderItems.map(x=>({codeId:x.codeId, qty:x.qty})),
      createdAt: Date.now()
    };
    const all = Store.getLists();
    all.push(lista);
    Store.setLists(all);
    builderItems = [];
    renderListBuilder();
    listSavedMsg.style.display = '';
    toast('Lista salvata');
    lNome.value = ''; lDesc.value = '';
    refreshExportLists();
  });

  /***************************
   * TUTTI I CODICI: TABELLA
   ***************************/
  const codesSearch = document.getElementById('codesSearch');
  const codesTableWrap = document.getElementById('codesTableWrap');
  const codesCount = document.getElementById('codesCount');

  function renderCodesTable(){
    const q = (codesSearch.value||'').toLowerCase().trim();
    const codes = Store.getCodes().sort((a,b)=> (a.titolo||'').localeCompare(b.titolo||''));
    codesCount.textContent = codes.length;
    const list = q ? codes.filter(c =>
      (c.titolo||'').toLowerCase().includes(q) ||
      (c.codice||'').toLowerCase().includes(q) ||
      (c.descrizione||'').toLowerCase().includes(q)
    ) : codes;
    if(!list.length){
      codesTableWrap.innerHTML = `<div class="empty">Nessun elemento${q?` per "<strong>${escapeHTML(q)}</strong>"`:''}.</div>`;
      return;
    }
    const rows = list.map(c=>`
      <tr>
        <td><strong>${escapeHTML(c.titolo)}</strong><div class="muted">${escapeHTML(c.codice)}</div></td>
        <td>${escapeHTML(c.quantita ?? 0)}</td>
        <td>${escapeHTML(c.unita || '')}</td>
        <td class="muted" title="${escapeHTML(c.descrizione||'')}">${escapeHTML((c.descrizione||'').slice(0,60))}${(c.descrizione||'').length>60?'‚Ä¶':''}</td>
        <td class="muted">${c.updatedAt? 'mod. ' + new Date(c.updatedAt).toLocaleDateString('it-IT'): new Date(c.createdAt).toLocaleDateString('it-IT')}</td>
        <td style="text-align:right; white-space:nowrap">
          <button class="btn" data-edit="${c.id}">Modifica</button>
          <button class="btn ghost" data-dup="${c.id}" title="Duplica">Duplica</button>
          <button class="btn ghost" data-del="${c.id}" title="Elimina">üóëÔ∏è</button>
        </td>
      </tr>
    `).join('');
    codesTableWrap.innerHTML = `
      <div class="card" style="overflow:auto">
        <table class="table">
          <thead>
            <tr><th>Elemento</th><th>Q.t√†</th><th>Unit√†</th><th>Descrizione</th><th>Data</th><th style="text-align:right">Azioni</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;

    // Bind azioni
    codesTableWrap.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-edit');
        const item = Store.getCodes().find(x=>x.id===id);
        if(!item) return;
        fillCodeForm(item);
        editingId = id;
        codeFormTitle.textContent = 'Modifica codice';
        editBadge.style.display = '';
        goTo('#screen-add-code');
      });
    });
    codesTableWrap.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-del');
        if(!confirm('Eliminare questo codice?')) return;
        const rest = Store.getCodes().filter(x=>x.id!==id);
        Store.setCodes(rest);
        toast('Codice eliminato');
        renderCodesTable();
      });
    });
    codesTableWrap.querySelectorAll('[data-dup]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-dup');
        const c = Store.getCodes().find(x=>x.id===id);
        if(!c) return;
        const copy = {...c, id: uid(), codice: c.codice + '-COPY', createdAt: Date.now(), updatedAt: undefined};
        const all = Store.getCodes(); all.push(copy); Store.setCodes(all);
        toast('Duplicato creato');
        renderCodesTable();
      });
    });
  }
  codesSearch.addEventListener('input', renderCodesTable);

  /***************************
   * ESPORTAZIONE / IMPORT
   ***************************/
  const listSelectExport = document.getElementById('listSelectExport');
  const btnExportPDF = document.getElementById('btnExportPDF');
  const btnExportJSON = document.getElementById('btnExportJSON');
  const fileImportJSON = document.getElementById('fileImportJSON');
  const btnWipeAll = document.getElementById('btnWipeAll');

  function refreshExportLists(){
    const lists = Store.getLists().sort((a,b)=> (a.nome||'').localeCompare(b.nome||''));
    listSelectExport.innerHTML = lists.length
      ? lists.map(l=>`<option value="${l.id}">${escapeHTML(l.nome)}</option>`).join('')
      : `<option value="">(Nessuna lista disponibile)</option>`;
  }
  refreshExportLists();

  btnExportJSON.addEventListener('click', ()=>{
    const payload = {
      exportedAt: new Date().toISOString(),
      app: 'Gestione Materiali Glass',
      name: Store.getName(),
      codes: Store.getCodes(),
      lists: Store.getLists()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:`gestione-materiali_${Date.now()}.json`});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    toast('JSON esportato');
  });

  btnExportPDF.addEventListener('click', ()=>{
    const listId = listSelectExport.value;
    const lists = Store.getLists();
    const codes = Object.fromEntries(Store.getCodes().map(c=>[c.id,c]));
    const l = lists.find(x=>x.id===listId);
    if(!l){ toast('Seleziona una lista valida', false); return; }
    // costruisci HTML stampabile
    const rows = l.items.map((it,i)=>{
      const c = codes[it.codeId] || {};
      return `<tr>
        <td style="padding:6px 10px; border:1px solid #ccc">${i+1}</td>
        <td style="padding:6px 10px; border:1px solid #ccc"><strong>${escapeHTML(c.titolo||'[eliminato]')}</strong><div style="color:#555; font-size:12px">${escapeHTML(c.codice||'')}</div></td>
        <td style="padding:6px 10px; border:1px solid #ccc">${escapeHTML(c.unita||'')}</td>
        <td style="padding:6px 10px; border:1px solid #ccc; text-align:right">${it.qty}</td>
        <td style="padding:6px 10px; border:1px solid #ccc">${escapeHTML(c.descrizione||'')}</td>
      </tr>`;
    }).join('');
    const win = window.open('', '_blank');
    const dateStr = new Date().toLocaleString('it-IT', {timeZone:TZ});
    const user = Store.getName() || '';
    win.document.write(`
      <html><head><meta charset="utf-8"><title>Lista - ${escapeHTML(l.nome)}</title>
      <style>
        body{ font-family: Arial, Helvetica, sans-serif; padding:24px; color:#111 }
        h1{ margin:0 0 6px 0 } h2{ margin:4px 0 18px 0; font-size:14px; color:#444 }
        table{ border-collapse: collapse; width:100% }
        .meta{ margin-bottom:12px; color:#444; font-size:13px }
      </style></head><body>
        <h1>Esportazione lista</h1>
        <h2>${escapeHTML(l.nome)}</h2>
        <div class="meta">Tecnico: <strong>${escapeHTML(user)}</strong> ¬∑ Data: ${escapeHTML(dateStr)}${l.descrizione? ' ¬∑ Note: '+escapeHTML(l.descrizione):''}</div>
        <table>
          <thead>
            <tr>
              <th style="padding:6px 10px; border:1px solid #ccc; text-align:left; width:40px">#</th>
              <th style="padding:6px 10px; border:1px solid #ccc; text-align:left">Materiale</th>
              <th style="padding:6px 10px; border:1px solid #ccc; text-align:left; width:90px">Unit√†</th>
              <th style="padding:6px 10px; border:1px solid #ccc; text-align:right; width:80px">Q.t√†</th>
              <th style="padding:6px 10px; border:1px solid #ccc; text-align:left">Descrizione</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <script>window.addEventListener('load', ()=> setTimeout(()=> window.print(), 50));<\/script>
      </body></html>
    `);
    win.document.close();
  });

  fileImportJSON.addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!confirm('Importare i dati dal file? Questo SOSTITUIR√Ä i dati correnti.')) return;
      if(!Array.isArray(data.codes) || !Array.isArray(data.lists)) throw new Error('Formato non valido');
      Store.setCodes(sanitizeCodes(data.codes));
      Store.setLists(sanitizeLists(data.lists));
      if(typeof data.name==='string'){ Store.setName(data.name); updateHello(); }
      toast('Dati importati');
      renderCodesTable(); renderListBuilder(); renderSearchResults(); refreshExportLists();
    }catch(err){
      console.error(err);
      toast('Errore durante l‚Äôimportazione', false);
    } finally {
      e.target.value = '';
    }
  });

  btnWipeAll.addEventListener('click', ()=>{
    if(!confirm('Sei sicuro di voler eliminare TUTTI i dati locali (codici e liste)?')) return;
    localStorage.removeItem(Store.keyCodes);
    localStorage.removeItem(Store.keyLists);
    renderCodesTable(); refreshExportLists();
    toast('Archivio svuotato');
  });

  function sanitizeCodes(arr){
    return arr.filter(x=>x && typeof x==='object').map(x=>({
      id: x.id || uid(),
      titolo: String(x.titolo||''),
      codice: String(x.codice||''),
      descrizione: String(x.descrizione||''),
      quantita: Number.isFinite(+x.quantita) ? +x.quantita : 0,
      unita: String(x.unita||''),
      extra: String(x.extra||''),
      createdAt: Number.isFinite(+x.createdAt) ? +x.createdAt : Date.now(),
      updatedAt: Number.isFinite(+x.updatedAt) ? +x.updatedAt : undefined
    }));
  }
  function sanitizeLists(arr){
    return arr.filter(x=>x && typeof x==='object').map(x=>({
      id: x.id || uid(),
      nome: String(x.nome||''),
      descrizione: String(x.descrizione||''),
      items: Array.isArray(x.items) ? x.items.map(it=>({codeId:String(it.codeId||''), qty: Math.max(1, parseInt(it.qty||'1',10))})) : [],
      createdAt: Number.isFinite(+x.createdAt) ? +x.createdAt : Date.now()
    }));
  }

  /***************************
   * SICUREZZA HTML
   ***************************/
  function escapeHTML(str){
    return String(str||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  /***************************
   * AVVIO
   ***************************/
  // Popola iniziali
  renderCodesTable();
  renderSearchResults();
  renderListBuilder();
  refreshExportLists();

  // Permette "vai a" dai link rapidi senza raddoppiare listener (gi√† gestito sopra)
</script>
</body>
</html>
